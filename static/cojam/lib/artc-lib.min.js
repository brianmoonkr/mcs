!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("ARTC",[],t):"object"==typeof exports?exports.ARTC=t():e.ARTC=t()}(this,function(){return function(e){var t={};function n(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(s,i,function(t){return e[t]}.bind(null,i));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t,n){"use strict";var s,i="object"==typeof Reflect?Reflect:null,o=i&&"function"==typeof i.apply?i.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};s=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var r=Number.isNaN||function(e){return e!=e};function a(){a.init.call(this)}e.exports=a,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var c=10;function l(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function h(e,t,n,s){var i,o,r,a;if("function"!=typeof n)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n);if(void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),r=o[t]),void 0===r)r=o[t]=n,++e._eventsCount;else if("function"==typeof r?r=o[t]=s?[n,r]:[r,n]:s?r.unshift(n):r.push(n),(i=l(e))>0&&r.length>i&&!r.warned){r.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+r.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=r.length,a=c,console&&console.warn&&console.warn(a)}return e}function d(e,t,n){var s={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=function(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);this.fired||(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,o(this.listener,this.target,e))}.bind(s);return i.listener=n,s.wrapFn=i,i}function u(e,t,n){var s=e._events;if(void 0===s)return[];var i=s[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):g(i,i.length)}function p(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function g(e,t){for(var n=new Array(t),s=0;s<t;++s)n[s]=e[s];return n}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(e){if("number"!=typeof e||e<0||r(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");c=e}}),a.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||r(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return l(this)},a.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var s="error"===e,i=this._events;if(void 0!==i)s=s&&void 0===i.error;else if(!s)return!1;if(s){var r;if(t.length>0&&(r=t[0]),r instanceof Error)throw r;var a=new Error("Unhandled error."+(r?" ("+r.message+")":""));throw a.context=r,a}var c=i[e];if(void 0===c)return!1;if("function"==typeof c)o(c,this,t);else{var l=c.length,h=g(c,l);for(n=0;n<l;++n)o(h[n],this,t)}return!0},a.prototype.addListener=function(e,t){return h(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return h(this,e,t,!0)},a.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.on(e,d(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.prependListener(e,d(this,e,t)),this},a.prototype.removeListener=function(e,t){var n,s,i,o,r;if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);if(void 0===(s=this._events))return this;if(void 0===(n=s[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){r=n[o].listener,i=o;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(s[e]=n[0]),void 0!==s.removeListener&&this.emit("removeListener",e,r||t)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(e){var t,n,s;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,o=Object.keys(n);for(s=0;s<o.length;++s)"removeListener"!==(i=o[s])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this},a.prototype.listeners=function(e){return u(this,e,!0)},a.prototype.rawListeners=function(e){return u(this,e,!1)},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},a.prototype.listenerCount=p,a.prototype.eventNames=function(){return this._eventsCount>0?s(this._events):[]}},function(e,t,n){e.exports=n(2).default},function(e,t,n){"use strict";n.r(t);var s={};n.r(s),n.d(s,"request",function(){return i}),n.d(s,"parseToken",function(){return o}),n.d(s,"generateRandomString",function(){return r}),n.d(s,"wait",function(){return c}),n.d(s,"timeoutPromise",function(){return l}),n.d(s,"detectBrowser",function(){return d});const i=async({method:e,data:t,url:n})=>{return(await fetch(n,{method:e,body:JSON.stringify(t),headers:new Headers({"Content-Type":"application/json"})})).json()},o=(e="")=>{const t=`${e}`.split(".");if(1===t.length)return{};const n=t[1],s=window.atob(n);return JSON.parse(s)},r=e=>{let t="";const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split("");for(let s=0;s<e;s+=1){t+=n[Math.floor(Math.random()*n.length)]}return t};class a extends Error{constructor(e="Timeout..."){super(e)}}const c=e=>new Promise(t=>setTimeout(t,e)),l=(e,t)=>{let n;return Promise.race([e,new Promise((e,s)=>{n=setTimeout(()=>s(new a),t)})]).then(e=>(clearTimeout(n),e)).catch(e=>{throw clearTimeout(n),e})};function h(e,t,n){const s=e.match(t);return s&&s.length>=n&&parseInt(s[n],10)}function d(e){const{navigator:t}=e,n={browser:null,version:null};if(void 0===e||!e.navigator)return n.browser="Not a browser.",n;if(t.mozGetUserMedia)n.browser="firefox",n.version=h(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)n.browser="chrome",n.version=h(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))n.browser="edge",n.version=h(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return n.browser="Not a supported browser.",n;n.browser="safari",n.version=h(t.userAgent,/AppleWebKit\/(\d+)\./,1)}return n}class u{constructor({tag:e="ARTC",userId:t,address:n}){this._socket=null,this._sessionId=null,this._role=null,this._event=new Map,this._baseEvent=new Map,this._userId=t,this._tag=e,console.log(n),this._address=n,this._socketId=r(6),console.group(`Signal :: constructor :: ${this._tag}`),console.debug(`address :: ${this._address}`),console.debug(`userId :: ${this._userId}`),console.debug(`sockId :: ${this._socketId}`),console.groupEnd(),this._baseEvent.set("enter_response",e=>{const{sid:t}=e;this._sessionId=t})}connect(){return new Promise((e,t)=>{this._socket=new WebSocket(this._address),this._socket.onopen=()=>e(this._socket),this._socket.onerror=e=>t(e),this._socket.onmessage=e=>{try{const{data:t}=e,n=JSON.parse(t);console.group(`[ ${this._tag} ][ ${this._socketId} ][ RX ][ ${n.type} ] <----`),console.debug(n),console.groupEnd();const s=this._baseEvent.get(n.type);s&&s(n);const i=this._event.get(n.type);i&&i(n)}catch(e){console.error("[ ARTC ] error:",e)}},this._socket.onclose=e=>{throw console.group(`[ ${this._tag} ][ ${this._socketId} ] onclose`),console.debug(e),console.groupEnd(),e}})}isConnected(){return null!==this._socket&&1===this._socket.readyState}addResponseHandler(e,t){this._event.set(e,t)}_beforeSend(e){if(!this.isConnected())throw new Error("Not connected to signal");console.group(`[ ${this._tag} ][ ${this._socketId} ][ TX ][ ${e.type} ] ----\x3e`),console.log(e),console.groupEnd()}send(e,t){const n={...e,transaction:r(15),sid:this._sessionId,from:this._userId,to:t};this._beforeSend(n),this._socket.send(JSON.stringify(n))}enter(e,t,n,s){if(""===t)throw new Error("token is empty");const i={type:"enter",ptype:n,current_id:e,user_token:t,role:s};this.send(i)}enterP(e,t,n,s){return new Promise((i,o)=>{this.enter(e,t,n,s),this._event.set("enter_response",e=>200!==e.status?o(e):(console.debug(`[ ${this._tag} ][ ${this._socketId} ] enter success :: token :: ${t}`),i(e)))})}subscriberEnter(e,t,n,s){return new Promise((i,o)=>{this.enter(e,t,n,s),this._event.set("offer",e=>e.status&&200!==e.status?o(e):(console.debug(`[ ${this._tag} ][ ${this._socketId} ] enter success :: token :: ${t}`),i(e)))})}offer(e,t){return new Promise(n=>{this.send({type:"offer",sdp:e},t),this._event.set("answer",e=>(this._event.delete("answer"),n(e)))})}eventWait(){return new Promise((e,t)=>{this._event.set("event",n=>200!==n.status?t(n.response):(this._event.delete("event"),e(n)))})}answer(e,t){return new Promise(n=>{this.send({type:"answer",sdp:e},t),this._event.set("answer_response",()=>(this._event.delete("answer_response"),n()))})}startRelay(e){this.relay("start",e)}stopRelay(e){this.relay("stop",e)}relay(e,t){this.send({type:"relay",msg:e,sns:[...t]})}candidate(e,t){this.send({type:"candidate",...e},t)}close(){this._socket.close(),this._socket=null,this._socketId=null}closeTx(){this.send({type:"close"})}message(e,t){this.send({type:"message",msg:e},t)}opMessage(e,t){this.send({type:"op_message",msg:e},t)}isEntered(){return null!==this.sessionId}opMessageP(e,t){return new Promise((n,s)=>{this.opMessage(e,t),this._event.set("op_message_response",e=>{const{status:t}=e;return 200===t?(this._event.delete("op_message_response"),n(e)):(this._event.delete("op_message_response"),s(e))})})}}var p=n(0);const g=e=>{let t=e;return"number"!=typeof t&&(t=Number(t)),isNaN(t)?0:Math.max(0,t)},f=(e,t,n)=>{const s=g(e[n]),i=g(t[n]),o=Math.max(0,s-i),r=e.timestamp-t.timestamp;let a=0;return r>0&&(a=Math.round(8*o/r)),a},v=(e,t)=>{let n=e.getSenders().filter(e=>!!e.track&&e.track.id===t).map(e=>e.track);if(0!==n.length)return!0;if(0!==(n=e.getReceivers().filter(e=>!!e.track&&e.track.id===t).map(e=>e.track)).length)return!1;throw new Error("Not found track...")};class m{constructor(){this.loss={},this.bitrate={download:0,upload:0},this.video={send:{width:0,height:0,frameRate:0},recv:{width:0,height:0,frameRate:0}},this.codec={in:{audio:null,video:null},out:{audio:null,video:null}},this.bandwidth={download:0,upload:0},this.transport={ip:null,localIp:null,protocol:null,localCandidateType:null,remoteCandidateType:null,networkType:null,relayProtocol:null,rtt:0}}setLoss(e){this.loss=e||{}}setResolution(e){this.resolution=e||{}}addBitrate(e){this.bitrate.download+=e.download,this.bitrate.upload+=e.upload}resetBitrate(){this.bitrate.download=0,this.bitrate.upload=0}addCodec(e,t,n){if(!t||!n)return;const s=e?"in":"out",i=t.kind;this.codec[s][i]=n}}class y{constructor(e,t){this.peerconnection=e,this.eventEmitter=t,this.currentStat=null,this.previousStat=null,this.statTimerId=null,this.stats=new m}start(){this.statTimerId=setInterval(async()=>{const e=await this.peerconnection.getStats();let t=null;t=e&&e.result&&"function"==typeof e.result?e.result():e,this.currentStat=t,this._processStat(),this.previousStat=t},1e3)}async _processStat(){if(!this.previousStat)return;const e=[],t=[];this.currentStat.forEach(n=>{if("track"===n.type){if(t.push(n),"video"!==n.kind)return null;let e=n.framesPerSecond,s=null,i=null;if(v(this.peerconnection,n.trackIdentifier)?(s="send",i="framesSent"):(s="recv",i="framesReceived"),!e){const t=this.previousStat.get(n.id);if(t){const s=n.timestamp-t.timestamp;if(s>0&&n[i]){e=(n[i]-t[i])/s*1e3}}if(!e)return null}this.stats.video[s].width=n.frameWidth,this.stats.video[s].height=n.frameHeight,this.stats.video[s].frameRate=e}else"codec"===n.type&&e.push(n)}),this.currentStat.forEach(n=>{if("inbound-rtp"===n.type||"outbound-rtp"===n.type){const s=this.previousStat.get(n.id);let i=!0,o="packetsReceived";"outbound-rtp"===n.type&&(i=!1,o="packetsSent");let r=n[o];(!r||r<0)&&(r=0);const a=g(s[o]),c=Math.max(0,r-a),l=g(n.packetsLost),h=g(s.packetsLost),d=Math.max(0,l-h);this.stats.setLoss({packetsTotal:c+d,packetsLost:d,isDownloadStream:i});const u=e.filter(e=>e.id===n.codecId)[0],p=t.filter(e=>e.id===n.trackId)[0];"inbound-rtp"===n.type?(this.stats.addBitrate({download:f(n,s,"bytesReceived"),upload:0}),this.stats.addCodec(!0,p,u)):(this.stats.addBitrate({download:0,upload:f(n,s,"bytesSent")}),this.stats.addCodec(!1,p,u))}else if("candidate-pair"===n.type&&n.nominated&&"succeeded"===n.state){const{availableIncomingBitrate:e,availableOutgoingBitrate:t}=n;(e||t)&&(this.stats.bandwidth={download:Math.round(g(e)/1e3),upload:Math.round(g(t)/1e3)});const{remoteCandidateId:s,localCandidateId:i}=n,o=this.currentStat.get(s),r=this.currentStat.get(i);if(r&&o){const{ip:e,port:t,candidateType:s,protocol:i}=o,a=`${e}:${t}`,{ip:c,port:l,candidateType:h,networkType:d,relayProtocol:u}=r,p=`${c}:${l}`;this.stats.transport={ip:a,localIp:p,protocol:i,localCandidateType:h,remoteCandidateType:s,networkType:d,relayProtocol:u,rtt:1e3*n.currentRoundTripTime}}}}),this._emitReport()}_emitReport(){this.eventEmitter.emit("stat",this.stats)}stop(){null!==this.statTimerId&&(clearInterval(this.statTimerId),this.statTimerId=null)}}const w="local",b="remote",k="audio",C="video";class _ extends p.EventEmitter{constructor(){super(),this.peerconnection=null,this.datachannel=null,this.signal=null,this.signalPingId=null,this.statCollector=null}start(){this.startPing()}stop(){this.stopPing()}closeRtc(){null!==this.datachannel&&(this.datachannel.close(),this.datachannel=null),null!==this.peerconnection&&(this.peerconnection.close(),this.peerconnection=null)}closeSignal(){null!==this.signal&&this.signal.isConnected()&&(this.stopPing(),this.signal.close(),this.signal=null)}enableDeviceTrack(e,t,n){const s="local"===e?this.peerconnection.getSenders():this.peerconnection.getReceivers(),i="audio"===t?"audio":"video";s.filter(e=>e.track.kind===i).forEach(e=>{e.track.enabled=n})}enableLocalAudio(){this.enableDeviceTrack(w,k,!0)}enableLocalVideo(){this.enableDeviceTrack(w,C,!0)}enableRemoteAudio(){this.enableDeviceTrack(b,k,!0)}enableRemoteVideo(){this.enableDeviceTrack(b,C,!0)}disableLocalAudio(){this.enableDeviceTrack(w,k,!1)}disableLocalVideo(){this.enableDeviceTrack(w,C,!1)}disableRemoteAudio(){this.enableDeviceTrack(b,k,!1)}disableRemoteVideo(){this.enableDeviceTrack(b,C,!1)}isEnabledDeviceTrack(e,t){const n="local"===e?this.peerconnection.getSenders():this.peerconnection.getReceivers(),s="audio"===t?"audio":"video";return n.filter(e=>e.track.kind===s)[0].track.enabled}get isLocalAudioEnabled(){return this.isEnabledDeviceTrack(w,k)}get isLocalVideoEnabled(){return this.isEnabledDeviceTrack(w,C)}get isRemoteAudioEnabled(){return this.isEnabledDeviceTrack(b,k)}get isRemoteVideoEnabled(){return this.isEnabledDeviceTrack(b,C)}sendChatMessage(e){this.signal.message(e)}sendOpMessage(e,t){return this.signal.opMessageP(e,t)}sendClose(e){this.sendOpMessage(JSON.stringify({cmd:"close"}),e)}startPing(){null===this.signalPingId&&(this.signalPingId=setInterval(()=>this._sendPing(),15e3))}_sendPing(){this.signal.isConnected()&&this.signal.isEntered()&&this.sendOpMessage("keep_alive")}stopPing(){null!==this.signalPingId&&(clearInterval(this.signalPingId),this.signalPingId=null)}startStat(){null===this.statCollector&&(this.statCollector=new y(this.peerconnection,this)),this.statCollector.stop(),this.statCollector.start()}stopStat(){this.statCollector.stop(),this.statCollector=null}}class S{constructor({ctx:e,audioStream:t,visualiser:n}){this.audioContext=e,this.audioStream=t,this.visualiser=n,this.analyser=null,this.tick=this.tick.bind(this)}start(){this.analyser=this.audioContext.createAnalyser(),this.dataArray=new Uint8Array(this.analyser.frequencyBinCount),this.source=this.audioContext.createMediaStreamSource(this.audioStream),this.source.connect(this.analyser),this.rafId=requestAnimationFrame(this.tick)}stop(){cancelAnimationFrame(this.rafId),this.analyser.disconnect(),this.source.disconnect()}tick(){this.analyser.getByteTimeDomainData(this.dataArray),this.visualiser.draw(this.dataArray),this.rafId=requestAnimationFrame(this.tick)}}class T{constructor(e){this.canvas=document.querySelector(`#${e}`)}draw(e){const{width:t,height:n}=this.canvas,s=this.canvas.getContext("2d");let i=0;const o=1*t/e.length;s.lineWidth=2,s.strokeStyle="#000000",s.clearRect(0,0,t,n),s.beginPath(),s.moveTo(0,n/2);for(const t of e){const e=t/255*n;s.lineTo(i,e),i+=o}s.lineTo(i,n/2),s.stroke()}}class I{constructor(e,t){this.ctx=e,this.vol=e.createGain(),this.vol.gain.value=.3,this.lpf=e.createBiquadFilter(),this.lpf.type="lowpass",this.lpf.Q.value=5,this.lpf.frequency.value=1500,this.vol.connect(this.lpf),this.lpf.connect(t),this.seq=[33,33,40,33,33,40,33,33,33,33,40,33,33,40,33,33,31,31,31,38,38,31,31,38,29,29,36,29,36,29,29,29]}play(e,t){const n=this.ctx.createOscillator();n.type="sawtooth",n.frequency.value=440*2**((this.seq[e%32]-69)/12),n.connect(this.vol),n.start(t),n.stop(t+.08)}}class R{constructor(e,t){this.ctx=e,this.vol=e.createGain(),this.vol.gain.value=.1,this.delay=e.createDelay(),this.delay.delayTime.value=.2,this.feedback=e.createGain(),this.feedback.gain.value=.3,this.lpf=e.createBiquadFilter(),this.lpf.type="lowpass",this.lpf.Q.value=20,this.lpf.frequency.value=4e3,this.angle=0,this.vol.connect(this.lpf),this.lpf.connect(this.delay),this.lpf.connect(t),this.delay.connect(this.feedback),this.feedback.connect(this.delay),this.feedback.connect(t),this.seq=[69,72,76,74,71,69,72,76],this.lfo=this.lfo.bind(this),setInterval(this.lfo,100)}lfo(){this.angle+=.1,this.angle>2*Math.PI&&(this.angle-=2*Math.PI),this.lpf.frequency.value=4e3+3e3*Math.sin(this.angle)}play(e,t){for(let n=0;n<3;n+=1){const s=this.ctx.createOscillator();s.type="sawtooth";const i=3*n;s.frequency.value=440*2**((this.seq[e%8]-69)/12)+i,s.connect(this.vol),s.start(t),s.stop(t+.1)}}}class E{constructor(e){this.audioContext=e,this.isPlaying=!1,this.destination=this.audioContext.createMediaStreamDestination(),this.bass=new I(this.audioContext,this.destination),this.synth=new R(this.audioContext,this.destination),this.tick=this.tick.bind(this)}tick(){this.isPlaying&&(this.bass.play(this.idx,this.audioContext.currentTime+.1),this.synth.play(this.idx,this.audioContext.currentTime+.1),this.idx+=1,this.rafId=window.setTimeout(this.tick,100))}getStream(){return this.destination.stream}async start(){this.isPlaying=!0,this.idx=0,this.rafId=window.setTimeout(this.tick,100)}stop(){this.isPlaying=!1,window.clearTimeout(this.rafId)}}t.default=function(e){return"object"==typeof window.ARTC?Object.assign({},window.ARTC,e):e}({UTIL:s,LIVE:{PUB:class extends _{constructor(){super(),this.tag="ARTCLivePub",this.token=null,this.userId=null,this.signal=null,this.peerconnection=null,this.onOpen=null,this.onTrack=null,this.onClose=null,this.onError=null,this.onMessage=null,this.onStat=null,this.on("stat",e=>{null!==this.onStat&&this.onStat(e)})}async start({tracks:e,token:t=null,userId:n,onOpen:s,onTrack:i,onMessage:r,onClose:a,onError:c,onStat:l=null}){try{this.tracks=e,this.token=t,this.userId=n;const h=o(t);console.log("tokenInfo:",h);const{ws_public_address:d}=h;if(this.signal=new u({tag:this.tag,userId:this.userId,address:d}),this.onOpen=s||console.log,this.onTrack=i||console.log,this.onMessage=r||console.log,this.onClose=a||console.log,this.onError=c||console.error,this.onStat=l,this.signal.addResponseHandler("message",e=>{e.from!==this.userId&&(console.log(`${this.tag} ${JSON.stringify(e,null,2)}`),this.onMessage(e))}),this.signal.addResponseHandler("candidate",e=>{if(null===this.peerconnection)return;const{candidate:t,sdpMid:n,sid:s,completed:i}=e;i||this.peerconnection.addIceCandidate(new RTCIceCandidate({candidate:t,sdpMid:n,sid:s}))}),await this.signal.connect(),null===t)throw new Error("Token is empty");await this.signal.enterP(this.userId,this.token,"pub","core"),this.startPing(),this._createPeerConnection();const p=await this.peerconnection.createOffer({offerToReceiveAudio:!1,offerToReceiveVideo:!1,voiceActivityDetection:!1});p.sdp=this.sdpToAddBandwidth(p.sdp);const g=await this.signal.offer(p);await this.peerconnection.setLocalDescription(p),await this.peerconnection.setRemoteDescription(new RTCSessionDescription(g))}catch(e){console.error(`${this.tag} error:`,e),this.onError(e)}}sdpToAddBandwidth(e){var t=e.match(/a=group:BUNDLE (.*)?\r\n/);if(!t)return e;if(!t[1])return e;t=t[1].split(" "),e=e.replace(/b=AS([^\r\n]+\r\n)/g,"");for(var n=0;n<t.length;n++)"audio"===t[n]||"sdparta_0"===t[n]||"0"===t[n]?e=e.replace("a=mid:"+t[n]+"\r\n","a=mid:"+t[n]+"\r\nb=AS:32\r\n"):"video"===t[n]||"sdparta_1"===t[n]||"1"===t[n]?e=e.replace("a=mid:"+t[n]+"\r\n","a=mid:"+t[n]+"\r\nb=AS:2000\r\n"):"data"!==t[n]&&"sdparta_2"!==t[n]||(e=e.replace("a=mid:"+t[n]+"\r\n","a=mid:"+t[n]+"\r\nb=AS:1638400\r\n"));return e}stop(){this.stopPing(),this.closeRtc(),this.closeSignal()}_createPeerConnection(){this.peerconnection=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:["turn:13.209.250.18:3478?transport=udp"],username:"kurento",credential:"kurento"}]}),this.peerconnection.onicecandidate=e=>{const{candidate:t}=e;null!==t?this.signal.candidate({sdpMid:t.sdpMid,sdpMLineIndex:t.sdpMLineIndex,candidate:t.candidate}):this.signal.candidate({completed:!0})},this.peerconnection.oniceconnectionstatechange=()=>{null!==this.peerconnection&&(console.log(`${this.tag} state: ${this.peerconnection.iceConnectionState}`),"connected"===this.peerconnection.iceConnectionState?this.onOpen({token:this.token,rtcConnection:this.peerconnection}):"disconnected"===this.peerconnection.iceConnectionState&&this.onClose())},this.peerconnection.ontrack=e=>this.onTrack(e),this.tracks.forEach(e=>{this.peerconnection.addTrack(e)})}getSignal(){return this.signal}async replaceStream(e){try{this.stream=e,e.getTracks().forEach(e=>this.replaceTrack(e))}catch(e){throw console.error(e),e}}replaceTrack(e){this.peerconnection.getSenders().filter(t=>{const{track:n}=t;return null!==n&&n.kind===e.kind}).forEach(t=>t.replaceTrack(e))}},SUB:class extends _{constructor(){super(),this.tag="ARTCLiveSub",this.stream=null,this.token=null,this.userId=null,this.signal=null,this.peerconnection=null,this.onOpen=null,this.onTrack=null,this.onClose=null,this.onError=null,this.onMessage=null,this.onOperation=null,this.preReceivedOffer=null,this.onStat=null,this.on("stat",e=>{null!==this.onStat&&this.onStat(e)})}async start({token:e,userId:t,onOpen:n,onTrack:s,onMessage:i,onOperation:r,onClose:a,onError:c,onStat:l=null}){try{this.token=e,this.userId=t;const h=o(e);console.log("tokenInfo:",h);const{ws_public_address:d}=h;this.signal=new u({tag:this.tag,userId:this.userId,address:d}),this.onOpen=n||console.log,this.onTrack=s||console.log,this.onClose=a||console.log,this.onError=c||console.error,this.onMessage=i||console.log,this.onOperation=r||console.log,this.onStat=l,this.signal.addResponseHandler("event",e=>{const{response:t}=e;"hangup"===t&&this.onClose()}),this.signal.addResponseHandler("message",e=>{e.from!==this.userId&&(console.log(`${this.tag} ${JSON.stringify(e,null,2)}`),this.onMessage(e))}),this.signal.addResponseHandler("candidate",e=>{if(null===this.peerconnection)return;const{candidate:t,sdpMid:n,sid:s,completed:i}=e;i||this.peerconnection.addIceCandidate(new RTCIceCandidate({candidate:t,sdpMid:n,sid:s}))}),this.signal.addResponseHandler("op_message",e=>{const{msg:t}=e;try{this.onOperation(JSON.parse(t))}catch(e){this.onOperation(t)}}),this.signal.addResponseHandler("offer",e=>{this.signal.isEntered()?(console.log("normal case of offer..."),this.receiveOffer(e)):(console.log(`${this.tag} abnormal case: too fast received... keep offer`),this.preReceivedOffer=e)}),await this.signal.connect(),await this.signal.enterP(this.userId,this.token,"sub","jamer"),this.startPing(),null!==this.preReceivedOffer&&(console.log(`${this.tag} abnormal case: too fast received... pop offer`),await this.receiveOffer(this.preReceivedOffer),this.preReceivedOffer=null)}catch(e){console.error(`${this.tag} error:`,e),this.onError(e)}}async receiveOffer(e){null===this.peerconnection&&this._createPeerConnection(),await this.peerconnection.setRemoteDescription(new RTCSessionDescription(e));const t=await this.peerconnection.createAnswer({offerToReceiveAudio:!0,offerToReceiveVideo:!0,voiceActivityDetection:!1});await this.signal.answer(t),await this.peerconnection.setLocalDescription(t)}stop(){this.stopPing(),this.closeRtc(),this.closeSignal()}_createPeerConnection(){this.peerconnection=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:["turn:13.209.250.18:3478?transport=udp"],username:"kurento",credential:"kurento"}]}),this.peerconnection.onicecandidate=e=>{const{candidate:t}=e;null!==t?this.signal.candidate({sdpMid:t.sdpMid,sdpMLineIndex:t.sdpMLineIndex,candidate:t.candidate}):this.signal.candidate({completed:!0})},this.peerconnection.oniceconnectionstatechange=()=>{console.log(`${this.tag} state: ${this.peerconnection.iceConnectionState}`),"connected"===this.peerconnection.iceConnectionState?this.onOpen({token:this.token,rtcConnection:this.peerconnection}):"disconnected"===this.peerconnection.iceConnectionState&&this.onClose()},this.peerconnection.ontrack=e=>this.onTrack(e)}getSignal(){return this.signal}}},P2P:{CALLER:class extends _{constructor(){super(),this.tag="P2PCaller",this.token=null,this.stream=null,this.userId=null,this.targetId=null,this.onOpen=null,this.onTrack=null,this.onEnter=null,this.onClose=null,this.onError=null,this.onOperation=null,this.peerconnection=null,this.datachannel=null,this.signal=null,this.isDataChannelEnabled=!0,this.onStat=null,this.on("stat",e=>{null!==this.onStat&&this.onStat(e)})}async start({stream:e,tracks:t,userId:n,token:s,onOpen:i,onTrack:r,onEnter:a,onMessage:c,onOperation:l,onClose:h,onError:d,isDataChannelEnabled:p=!0,onStat:g=null}){try{this.tracks=t,this.userId=n,this.token=s,this.onOpen=i||console.log,this.onTrack=r||console.log,this.onEnter=a||console.log,this.onMessage=c||console.log,this.onOperation=l||console.log,this.onClose=h||console.log,this.onError=d||console.error,this.onStat=g;const e=o(s),{ws_public_address:f}=e;this.signal=new u({tag:this.tag,userId:this.userId,address:f}),this.isDataChannelEnabled=p,this.signal.addResponseHandler("message",e=>{e.from!==this.userId&&(this.isDataChannelEnabled||(console.log(`${this.tag} ${JSON.stringify(e,null,2)}`),this.onMessage(e)))}),this.signal.addResponseHandler("join",e=>{const{from:t}=e;t!==this.userId?this.call(t):console.log(`${this.tag} joined :: me -> exit`)}),this.signal.addResponseHandler("candidate",e=>{if(console.log("#### candidate:",e),null===this.peerconnection)return;const{candidate:t,sdpMid:n,sid:s,completed:i}=e;if(!i)try{this.peerconnection.addIceCandidate(new RTCIceCandidate({candidate:t,sdpMid:n,sid:s}))}catch(e){console.error(e)}}),this.signal.addResponseHandler("op_message",e=>{const{msg:t}=e;try{this.onOperation(JSON.parse(t))}catch(e){this.onOperation(t)}}),await this.signal.connect(),await this.signal.enterP(this.userId,this.token),this.startPing(),this.onEnter(this.token),console.info(`${this.tag} wating user join..`)}catch(e){console.error(`${this.tag} error:`,e),this.onError(e)}}stop(){this.stopPing(),this.closeRtc(),this.closeSignal()}async call(e){this.targetId=e;try{this.createPeerConnection(this.targetId);const e=await this.peerconnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}),t=await this.signal.offer(e,this.targetId),{sdp:n}=t;await this.peerconnection.setLocalDescription(e),await this.peerconnection.setRemoteDescription(n)}catch(e){this.onError(e)}}createPeerConnection(e){this.peerconnection=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:["turn:13.209.250.18:3478?transport=udp"],username:"kurento",credential:"kurento"}]}),this.peerconnection.onicecandidate=t=>{const{candidate:n}=t;null!==n?this.signal.candidate({sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex,candidate:n.candidate},e):this.signal.candidate({completed:!0},e)},this.peerconnection.oniceconnectionstatechange=()=>{null!==this.peerconnection&&(console.info(`${this.tag} state: ${this.peerconnection.iceConnectionState}`),"connected"===this.peerconnection.iceConnectionState?this.onOpen({token:this.token,rtcConnection:this.peerconnection}):"disconnected"===this.peerconnection.iceConnectionState&&this.onClose())},this.peerconnection.ontrack=e=>this.onTrack(e),this.createDataChannel()}createDataChannel(){null!==this.peerconnection&&(this.datachannel=this.peerconnection.createDataChannel("p2p-chat",{ordered:!1}),this.datachannel.onerror=e=>this.onError(e),this.datachannel.onmessage=e=>this.onMessage(e))}_sendDataChannel(e){null!==this.datachannel&&this.datachannel.send(e)}sendChatMessage(e){this.isDataChannelEnabled?this.sendDataChannel(e):this.signal.message(e)}getSignal(){return this.signal}enableDataChannel(e){this.isDataChannelEnabled=e}sendClose(){super.sendClose(this.targetId)}},CALLEE:class extends _{constructor(){super(),this.tag="P2PCallee",this.stream=null,this.userId=null,this.targetId=null,this.onOpen=null,this.onTrack=null,this.onEnter=null,this.onClose=null,this.onError=null,this.onOperation=null,this.peerconnection=null,this.datachannel=null,this.signal=null,this.isDataChannelEnabled=!0,this.preReceivedOffer=null,this.onStat=null,this.on("stat",e=>{null!==this.onStat&&this.onStat(e)})}async start({stream:e,token:t=null,userId:n,onEnter:s,onOpen:i,onTrack:r,onMessage:a,onOperation:c,onClose:l,onError:h,isDataChannelEnabled:d=!0,onStat:p=null}){try{this.stream=e,this.token=t,this.userId=n;const g=o(t);console.log("tokenInfo:",g);const{ws_public_address:f}=g;this.signal=new u({tag:this.tag,userId:this.userId,address:f}),this.isDataChannelEnabled=d,this.onOpen=i||console.log,this.onTrack=r||console.log,this.onEnter=s||console.log,this.onMessage=a||console.log,this.onOperation=c||console.log,this.onClose=l||console.log,this.onError=h||console.error,this.onStat=p,this.signal.addResponseHandler("message",e=>{e.from!==this.userId&&(this.isDataChannelEnabled||(console.log(`${this.tag} ${JSON.stringify(e,null,2)}`),this.onMessage(e)))}),this.signal.addResponseHandler("candidate",e=>{if(null===this.peerconnection)return;const{candidate:t,sdpMid:n,sid:s,completed:i}=e;i||this.peerconnection.addIceCandidate(new RTCIceCandidate({candidate:t,sdpMid:n,sid:s}))}),this.signal.addResponseHandler("op_message",e=>{const{msg:t}=e;try{this.onOperation(JSON.parse(t))}catch(e){this.onOperation(t)}}),this.signal.addResponseHandler("offer",e=>{this.signal.isEntered()?(console.log("normal case of offer..."),console.log(e),this.receiveOffer(e)):(console.log("abnormal case: too fast received... keep offer"),console.log(e),this.preReceivedOffer=e)}),await this.signal.connect(),await this.signal.enterP(this.userId,this.token),this.startPing(),null!==this.preReceivedOffer&&(console.log("abnormal case: too fast received... pop offer"),console.log(this.preReceivedOffer),await this.receiveOffer(this.preReceivedOffer),this.preReceivedOffer=null)}catch(e){console.error(`${this.tag} error:`,e),this.onError(e)}}async receiveOffer(e){const{from:t,sdp:n}=e;console.log(n),this.targetId=t,null===this.peerconnection&&this.createPeerConnection(this.targetId),await this.peerconnection.setRemoteDescription(new RTCSessionDescription(n));const s=await this.peerconnection.createAnswer();await this.signal.answer(s,this.targetId),await this.peerconnection.setLocalDescription(s)}stop(){this.stopPing(),this.closeRtc(),this.closeSignal()}createPeerConnection(e){this.peerconnection=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:["turn:13.209.250.18:3478?transport=udp"],username:"kurento",credential:"kurento"}]}),this.peerconnection.onicecandidate=t=>{const{candidate:n}=t;null!==n?this.signal.candidate({sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex,candidate:n.candidate},e):this.signal.candidate({completed:!0},e)},this.peerconnection.oniceconnectionstatechange=()=>{null!==this.peerconnection&&(console.info(`${this.tag} state: ${this.peerconnection.iceConnectionState}`),"connected"===this.peerconnection.iceConnectionState?this.onOpen({token:this.token,rtcConnection:this.peerconnection}):"disconnected"===this.peerconnection.iceConnectionState&&this.onClose())},this.peerconnection.ontrack=e=>this.onTrack(e),this.stream.getTracks().forEach(e=>this.peerconnection.addTrack(e,this.stream)),this.createDataChannel()}createDataChannel(){null!==this.peerconnection&&(this.peerconnection.ondatachannel=e=>{this.datachannel=e.channel,this.datachannel.onerror=e=>this.onError(e),this.datachannel.onmessage=e=>this.onMessage(e)})}sendDataChannel(e){null!==this.datachannel&&this.datachannel.send(e)}sendChatMessage(e){this.isDataChannelEnabled?this.sendDataChannel(e):this.signal.message(e)}getSignal(){return this.signal}enableDataChannel(e){this.isDataChannelEnabled=e}sendClose(){super.sendClose(this.targetId)}}},extern:{visualiser:({ctx:e,audioStream:t,canvasId:n})=>{const s=new T(n);return new S({ctx:e,audioStream:t,visualiser:s})},creator:e=>new E(e)}})}])});
//# sourceMappingURL=artc-lib.min.map